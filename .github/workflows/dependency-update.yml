name: Dependency Update

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: 17
        distribution: 'temurin'
        cache: 'maven'
    
    - name: Update dependencies
      run: |
        mvn versions:use-latest-releases -DallowMajorUpdates=false
        mvn versions:update-properties -DallowMajorUpdates=false
    
    - name: Build and test
      run: mvn clean verify
      continue-on-error: true
    
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore(deps): update dependencies'
        title: 'chore(deps): Update dependencies'
        body: |
          ## Dependency Updates
          
          This PR updates project dependencies to their latest compatible versions.
          
          ### Changes
          - Updated dependencies to latest releases
          - Updated properties to latest versions
          
          ### Verification
          - [ ] Build passes
          - [ ] Tests pass
          - [ ] No breaking changes
          
          This PR was automatically generated by the dependency-update workflow.
        branch: deps/update-dependencies
        delete-branch: true
        labels: dependencies, automated

  dependabot-auto-merge:
    name: Auto-merge Dependabot PRs
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    needs: []
    permissions:
      pull-requests: write
      contents: write
    
    steps:
    - name: Dependabot metadata
      id: metadata
      uses: dependabot/fetch-metadata@v2
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Enable auto-merge for Dependabot PRs
      if: steps.metadata.outputs.update-type == 'version-update:semver-patch' || steps.metadata.outputs.update-type == 'version-update:semver-minor'
      run: gh pr merge --auto --squash "$PR_URL"
      env:
        PR_URL: ${{github.event.pull_request.html_url}}
        GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

